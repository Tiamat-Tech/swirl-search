<div class="swirl-iframe-container">
  <iframe
    id="swirl-chat-iframe"
    frameborder="0"
    allowfullscreen
    style="width:100%; height:80vh;"
  ></iframe>
</div>
{% assign chat_origin = include.chat_origin | default: "https://chat.docs.swirlaiconnect.com" %}
<script>
  const CHAT_ORIGIN = {{ chat_origin | jsonify }};

  const getCookie = (name) =>
    document.cookie.split('; ').find(c => c.startsWith(name + '='))?.split('=')[1] || null;

  async function initSwirlChat() {
    console.log('initSwirlChat start');
    try {
      const resp = await fetch(`${CHAT_ORIGIN}/swirl/init-session/`, {
        method: 'GET',
        credentials: 'include'
      });
      if (!resp.ok) throw new Error(`Init failed: ${resp.status}`);

      const { token } = await resp.json();
      const csrfToken = getCookie('csrftoken');

      const iframe = document.getElementById('swirl-chat-iframe');
      iframe.src = `${CHAT_ORIGIN}/galaxy/pre-chat`;

      iframe.onload = () => {
        console.log('posting setLocalStorage message');
        iframe.contentWindow.postMessage({
          action: 'setLocalStorage',
          payload: {
            'swirl-token': token,
            'swirl-chat-status': 'true',
            'swirl-rag-rating-status': 'true',
            'csrftoken': csrfToken
          }
        }, CHAT_ORIGIN);
      };
    } catch (err) {
      console.error('initSwirlChat error:', err);
      document.body.insertAdjacentHTML(
        'beforeend',
        `<p style="color:red">Chat unavailable: ${err.message}</p>`
      );
    }
    console.log('initSwirlChat end');
  }

  console.log('registering initSwirlChat listener');
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSwirlChat);
  } else {
    console.log('document already ready â€” calling initSwirlChat');
    initSwirlChat();
  }
</script>
